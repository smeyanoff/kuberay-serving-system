# ML System Design Doc - [RU]
## Дизайн ML системы - API-сервис скоринга заемщиков

> ## Термины и пояснения
> - Итерация - это все работы, которые совершаются до старта очередного пилота
> - БТ - бизнес-требования
> - EDA - Exploratory Data Analysis - исследовательский анализ данных

### 1. Цели и предпосылки
#### 1.1. Обоснованность разработки продукта

`Бизнес-цель` - автоматизация работы андеррайтеров в банке для:
- Определения надежности клиента (скоринг)
- Увеличение скорости принятия решения

##### Текущий бизнес-процесс
Компания `ОБЫЧНЫЙ БАНК` представляет финансовые услуги. Текущий процесс принятия решения по заемщику - это ручной андеррайтинг заемщика в отделении банка.
##### Польза от внедрения ML
С помощью внедрения сервиса:
- Увеличится скорость принятия решения
- Увеличится точность принятия решения, снизятся риски
- Сократится нагрузка на андеррайтеров
##### Критерии успеха
- Модели обладают разделяющей способностью большей, чем андеррайтер; >= 40 GINI.

Некорректный прогноз означает увеличение потерь в результате невозврата кредитов недобросовестными заемщиками.

`Функция GINI`

- Разработаны модели для трех основых банковских продуктов
- Скорость обработки заявки <= 10 сек.

#### 1.2. Бизнес-требования и ограничения

- Краткое описание бизнес-требований:
Система должна проводить оценку заемщиков на основе различных факторов, таких как история кредитования, финансовое положение, стабильность дохода и другие сведения.
Система скоринга должна способствовать прогнозированию вероятности возврата кредита заемщиком в установленные сроки.

- Бизнес-ограничения:
Система должна оперативно принимать решения, соблюдая установленные сроки, чтобы обеспечивать оперативность предоставления финансовых услуг.
Система должна стремиться к минимизации ошибок в принятии решений, чтобы избежать отказов кредитования тем, кто является надежным заемщиком.
Баланс между точностью модели и предотвращением ложных отказов должен быть настроен для поддержания клиентского опыта и соблюдения требований регулирования.
Система должна соответствовать законодательству и нормативам, регулирующим предоставление финансовых услуг и использование данных о клиентах.

##### Результат итерации
- Разработан API-сервис
- Разработаны модели
- Разработана система мониторинга моделей

##### Описание бизнес-процесса пилота
Пилот будет использоваться в системе принятия решений банка и будет встроен в кредитный конвейер. Пилот должен принимать файлы в формате JSON и отдавать ответы от моделей.
Каждая из моделей должна быть доступна по уникальному URL.

##### Возможные пути развития проекта
Дальнейшим развитием проекта будет являться построение моделей для других продуктов и улучшение их точности.

#### 1.3. Что входит в скоуп проекта/итерации, что не входит

- На закрытие каких БТ подписываемся в данной итерации:
Разработка моделей прогнозированию вероятности возврата кредита в установленные сроки на основе различных данных о заемщике.  Создание инфраструктуры для доступа к моделям. Разработка системы мониторинга.
- Что не будет закрыто:
Для поддержания актуальности моделей, обычно используются автоматические системы переобучения. Разработка такой системы не входит в скоуп проекта и является дальнейшим улучшением.
- Описание результата с точки зрения качества кода и воспроизводимости решения
    - Результатом будет структурированный, соответствующий общепринятым правилам, код. Решение должно быть воспроизводимым, что будет достигаться путем фиксирования параметров и результатов экспериментов.
- Описание планируемого технического долга: оптимизация алгоритмов для повышения их эффективности и интерпретируемости

#### 1.4. Предпосылки решения

- Описание всех общих предпосылок решения, используемых в системе – с обоснованием от запроса бизнеса: какие блоки данных используем, горизонт прогноза, гранулярность модели, и др.
    - В качестве данных будем использовать кредитную историю, информацию о запросах кредитной истории, социально-демографические признаки клиентов.
    - Горизонт прогноза - 1 год.
    - Модель будет работать на уровне отдельного клиента
    - Мониторинг работы и анализ результатов необходим для своевременной калибровки моделей

### 2. Методология

#### 2.1. Постановка задачи

Создание прогнозных моделей(задача классификации) и инфраструктуры для доступа к ним.

#### 2.2. Блок-схема решения

<image src="scheme.png">

#### 2.3. Этапы решения задачи `Data Scientist`

- Этап 1 - Сбор и подготовка данных

На данном этапе происходит сбор, предобработка, генерация новых признаков. В качестве исходных данных будем использовать кредитную историю, информацию о запросах кредитной истории, социально-демографические признаки клиентов.
Результатом данного этапа должны быть полностью подготовленные для разработки моделей массивы данных.
- Этап 2 - Разработка прогнозных моделей

На данном этапе следует начать с выбора наиболее подходящей модели для задачи. Затем данные будут разделены на тренировочный, валидационный и тестовый наборы с обязательной фиксацией random seed для обеспечения воспроизводимости результатов. Далее будет проведено обучение модели и подбор гиперпараметров.

Оценивать модели будем с помощью метрики GINI:

$Gini_{normalized} = 2 * AUCROC - 1 \hspace{15pt}$

$AUCROC = \frac{\sum_{i=1}^{n_1} \sum_{j=1}^{n_0} S(x_i, x_j)}{n_1*n_0} \hspace{15pt}$

$S(x_i, x_j) = \begin{cases} 1, \enspace x_i > x_j\\ \frac{1}{2}, \enspace x_i = x_j \\ 0,\enspace x_i < x_j \end{cases}$
где $x_i$ — ответ алгоритма на i-ом объекте из распределения «1», $x_j$ — ответ алгоритма на j-ом объекте из распределения «0»

Результатом данного этапа должны быть успешно разработанные модели, которые помогут оценить кредитный риск клиентов.
- Этап 3 - Подготовка инфраструктуры для развертывания моделей

Данный этап заключается в подготовке инфраструктуры для развертывания моделей в виде API-сервиса. Это включает в себя настройку серверов и поднятие кластеров.
В результате данного этапа должен появиться доступ к моделям по API.
- Этап 4 - Внедрение мониторинга работы сервиса

После развертывания моделей необходимо произвести настройку мониторинга и логирования работы сервиса. Это позволит отслеживать производительность моделей в реальном времени и реагировать на возникающие проблемы.
Результатом данного этапа должна стать система мониторинга сервиса.
- Этап 5 - Разработка интерфейса для тестирования моделей

Также необходим интерфейс для тестирования работы сервиса. Он будет представлять собой телеграмм-бот с помощью которого можно будет получить доступ к сервису.
Результат данного этапа - работающий телеграмм-бот для доступа к сервису.
- Этап 6 - Подготовка финального отчета для бизнеса

На данном этапе формируется отчет, который предоставит бизнесу всю необходимую информацию о разработанной системе. Отчет будет содержать результаты тестирования моделей, мониторинга работы сервиса и рекомендации для дальнейшего развития проекта, включая увеличение количества моделей и улучшение их точности.

### 3. Подготовка пилота

#### 3.1. Способ оценки пилота

В качестве оценки пилота буден проведен скоринг тестового набора данных, в результате должны быть достигнуты определенные значения метрик. Также будет проверена работа сервиса под нагрузкой.

#### 3.2. Что считаем успешным пилотом

По завершению теста принимаем решение.
Успешным проведение пилота считается при условиях:
- Метрика GINI на тестовом наборе больше 40 пунктов;
- Сервис выдерживает нагрузку 3 одновременных запроса в секунду;
- Скорость обработки запроса меньше 10 секунд.

### 4. Внедрение `для production систем, если требуется`

> Заполнение раздела 4 требуется не для всех дизайн документов. В некоторых случаях результатом итерации может быть расчет каких-то значений, далее используемых в бизнес-процессе для пилота.

#### 4.1. Архитектура решения

- Блок схема и пояснения: сервисы, назначения, методы API `Data Scientist`

#### 4.2. Описание инфраструктуры и масштабируемости

- Какая инфраструктура выбрана и почему `Data Scientist`
- Плюсы и минусы выбора `Data Scientist`
- Почему финальный выбор лучше других альтернатив `Data Scientist`

#### 4.3. Требования к работе системы

- SLA, пропускная способность и задержка `Data Scientist`

#### 4.4. Безопасность системы

- Потенциальная уязвимость системы `Data Scientist`

#### 4.5. Безопасность данных

- Нет ли нарушений GDPR и других законов `Data Scientist`

#### 4.6. Издержки

- Расчетные издержки на работу системы в месяц `Data Scientist`

#### 4.5. Integration points

- Описание взаимодействия между сервисами (методы API и др.) `Data Scientist`

#### 4.6. Риски

- Описание рисков и неопределенностей, которые стоит предусмотреть `Data Scientist`

#### 4.7 Способы масштабирования сервиса

- Для каждой компоненты архитектуры описано, каким образом можно ее масштабировать. Также описаны потенциальные "бутылочные горлышки" системы - места, которые в будущем при увеличении нагрузки могут тормозить всю систему.

#### 4.8 Результаты НТ ???

- Дополнительный критерий о масштабируемости сервиса. Позволяет наглядно увидеть, как сервис реагирует на масштабирование. В результатах сервиса описаны сценарии нагрузки, сравнение времени отклика для каждого сценария, способы и сетап НТ.
